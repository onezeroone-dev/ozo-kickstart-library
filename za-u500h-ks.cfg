# Kickstart for linux-native
# Version  = RHEL9
# HOSTNAME = za-u500h
# DISK     = sda
# VGNAME   = zalmalinux
# NETDEV   = enp1s0
# GATEWAY  = 10.42.24.1
# IP       = 10.42.24.10
# NETMASK  = 255.255.255.0
# DNS1     = 1.1.1.1

# Install source
repo --name="AppStream" --baseurl=http://repo.almalinux.org/almalinux/9.5/AppStream/x86_64/os
url --url="http://repo.almalinux.org/almalinux/9.5/BaseOS/x86_64/os/"

# Use text install
text

# Kdump
%addon com_redhat_kdump --enable --reserve-mb='auto'
%end

# CIS Benchmark Level 2 Server
%addon com_redhat_oscap
    content-type = scap-security-guide
    datastream-id = scap_org.open-scap_datastream_from_xccdf_ssg-almalinux9-xccdf.xml
    xccdf-id = scap_org.open-scap_cref_ssg-almalinux9-xccdf.xml
    profile = xccdf_org.ssgproject.content_profile_cis
%end

# Keyboard layouts
keyboard --xlayouts='us'

# System language
lang en_US.UTF-8

# Package Selection - CIS
%packages
@^minimal-environment
aide
audit
firewalld
libpwquality
libselinux
nftables
openscap
openscap-scanner
scap-security-guide
sudo
systemd-journal-remote
-bind
-cyrus-imapd
-dhcp
-dnsmasq
-dovecot
-ftp
-gdm
-httpd
-mcstrans
-httpd
-net-snmp
-nginx
-openldap-clients
-rsync
-samba
-setroubleshoot
-squid
-telnet
-telnet-server
-tftp
-tftp-server
-vsftpd
-xinetd
-xorg-x11-server-common
-ypbind
-ypserv
# Package seelction - Clevis/LUKS
#clevis
#clevis-dracut
#clevis-luks
#clevis-systemd
#tpm2-tss
#tpm2-tools
# Package selection - MFA
#cyrus-sasl
#cyrus-sasl-lib
#cyrus-sasl-plain
#qrencode-libs
# Package selection - KVM
#bridge-utils
#libguestfs-tools
#libvirt
#libvirt-client
#qemu-kvm
#virt-install
#virt-top
# Package selection - additional desired packages
bzip2
dnf-automatic
#gdisk
kexec-tools
#mailx
#nss-tools
policycoreutils-python-utils
#postfix
#python3-pyasn1
#rsyslog
#wget
yum-utils
%end

# Skip the Setup Agent on first boot
firstboot --disable

# Disk configuration
ignoredisk --only-use=sda
zerombr
# Partition clearing information
clearpart --all --initlabel --drives=sda
# Disk partitioning information; total is 23040 MiB
part /boot --fstype="xfs" --ondisk=sda --size=953 --asprimary
part /boot/efi --fstype="efi" --ondisk=sda --size=477 --fsoptions="umask=0077,shortname=winnt"
part pv.01 --fstype="lvmpv" --ondisk=sda --size=64000 --encrypted --luks-version=luks1 --passphrase=password
volgroup zalmalinux --pesize 4096 pv.01
logvol /srv --fstype="xfs" --size=1024 --name=srv --vgname=zalmalinux
logvol /var/log/audit --fstype="xfs" --size=1024 --name=var_log_audit --vgname=zalmalinux
logvol swap --fstype="swap" --size=4096 --name=swap --vgname=zalmalinux
logvol /tmp --fstype="xfs" --size=2048 --name=tmp --vgname=zalmalinux
logvol /home --fstype="xfs" --size=2048 --name=home --vgname=zalmalinux
logvol /var/log --fstype="xfs" --size=1024 --name=var_log --vgname=zalmalinux
logvol /var --fstype="xfs" --size=4096 --name=var --vgname=zalmalinux
logvol / --fstype="xfs" --size=4096 --name=root --vgname=zalmalinux
logvol /var/tmp --fstype="xfs" --size=1024 --name=var_tmp --vgname=zalmalinux

# System timezone
timezone America/Denver --utc
timesource --ntp-pool pool.ntp.org

# Root password
rootpw password

# License agreement
eula --agreed

# Network information
network  --onboot=yes --device=enp1s0 --bootproto=static --ip=10.42.24.10 --netmask=255.255.255.0 --gateway=10.42.24.1 --nameserver=1.1.1.1,1.0.0.1 --noipv6 --activate
network  --hostname=za-u500h

# System services
services --enabled="chronyd"
services --enabled="firewalld"
services --enabled="libvirtd"
services --enabled="sshd"

# SELinux
selinux --enforcing

# Firewall
firewall --enabled --ssh

# Post-installation behavior
reboot

# System bootloader configuration
#bootloader --append=" crashkernel=auto" --location=mbr --boot-drive=sda

###############################################################################
# post chroot
%post --interpreter=/usr/bin/bash --erroronfail --log=/root/ks-post-chroot.log

# Configure for EFI or Legacy
#if [ -e /boot/grub2/grub.cfg ]
#then
#  GRUB2_CONFIG_DIR="/boot/grub2"
#else
#  GRUB2_CONFIG_DIR="/boot/efi/EFI/almalinux"
#fi

#######################################
# Additional repos + packages

# Install EPEL repository and packages
dnf config-manager --set-enabled crb
dnf -y install epel-release
dnf repolist
dnf -y install google-authenticator joe pwgen screen

# Joe "nobackups"
sed -i s/" -nobackups"/"-nobackups"/g /etc/joe/joerc

# Use clevis to pin the LUKS volume to a TPM register
#tpm2_dictionarylockout --setup-parameters --max-tries=4294967295 --clear-lockout
#clevis luks bind -f -k- -d /dev/sda3 tpm2 '{"pcr_bank":"sha256","pcr_ids":"0,7"}' <<< "password"
#dracut -fv --regenerate-all

# Unexpire the root account
chage -M 99999 root

# Rewrite GRUB config
#grub2-mkconfig -o ${GRUB2_CONFIG_DIR}/grub.cfg

%end
